<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bitcoin Butlers - Nostr Order Bridge</title>
  <style>
    :root {
      --bg: #0d1117;
      --card: #161b22;
      --border: #30363d;
      --text: #c9d1d9;
      --text-muted: #8b949e;
      --accent: #f7931a;
      --accent-hover: #ffa940;
      --success: #3fb950;
      --error: #f85149;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 2rem;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    h1 {
      color: var(--accent);
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
    }
    
    .subtitle {
      color: var(--text-muted);
      font-size: 0.95rem;
    }
    
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .card h2 {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      color: var(--text);
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.4rem;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 0.75rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 1rem;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .row-3 {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 1rem;
    }
    
    button {
      width: 100%;
      padding: 1rem;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    button:hover:not(:disabled) {
      background: var(--accent-hover);
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .status {
      text-align: center;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      display: none;
    }
    
    .status.show { display: block; }
    .status.loading { background: var(--card); color: var(--text); }
    .status.success { background: #1a3d1f; color: var(--success); }
    .status.error { background: #3d1a1a; color: var(--error); }
    
    .invoice-link {
      display: block;
      margin-top: 1rem;
      padding: 1rem;
      background: var(--accent);
      color: #000;
      text-decoration: none;
      text-align: center;
      border-radius: 8px;
      font-weight: 600;
    }
    
    .invoice-link:hover {
      background: var(--accent-hover);
    }
    
    .info {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
    }
    
    .products-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .product-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    
    .product-item:hover {
      border-color: var(--accent);
    }
    
    .product-item.selected {
      border-color: var(--accent);
      background: rgba(247, 147, 26, 0.1);
    }
    
    .product-item input[type="radio"] {
      width: auto;
      margin-right: 0.75rem;
    }
    
    .product-info {
      flex: 1;
    }
    
    .product-name {
      font-weight: 500;
    }
    
    .product-price {
      color: var(--accent);
      font-weight: 600;
    }
    
    footer {
      text-align: center;
      margin-top: 2rem;
      color: var(--text-muted);
      font-size: 0.85rem;
    }
    
    footer a {
      color: var(--accent);
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>₿itcoin Butlers</h1>
      <p class="subtitle">Nostr Order Bridge — Pay with Lightning ⚡</p>
    </header>
    
    <form id="orderForm">
      <div class="card">
        <h2>1. Select Product</h2>
        <div class="products-list" id="productsList">
          <!-- Products loaded dynamically -->
        </div>
        <div class="form-group" style="margin-top: 1rem;">
          <label for="quantity">Quantity</label>
          <input type="number" id="quantity" min="1" value="1" required>
        </div>
      </div>
      
      <div class="card">
        <h2>2. Shipping Details</h2>
        <div class="form-group">
          <label for="name">Full Name</label>
          <input type="text" id="name" required placeholder="Satoshi Nakamoto">
        </div>
        <div class="form-group">
          <label for="street">Street Address</label>
          <input type="text" id="street" required placeholder="123 Bitcoin Lane">
        </div>
        <div class="row-3">
          <div class="form-group">
            <label for="city">City</label>
            <input type="text" id="city" required placeholder="Austin">
          </div>
          <div class="form-group">
            <label for="region">State/Region</label>
            <input type="text" id="region" placeholder="TX">
          </div>
          <div class="form-group">
            <label for="zip">ZIP/Postal</label>
            <input type="text" id="zip" required placeholder="78701">
          </div>
        </div>
        <div class="form-group">
          <label for="country">Country</label>
          <input type="text" id="country" required placeholder="USA">
        </div>
      </div>
      
      <div class="card">
        <h2>3. Contact (for order updates)</h2>
        <div class="form-group">
          <label for="contact">Email, Nostr npub, or other contact</label>
          <input type="text" id="contact" required placeholder="your@email.com or npub1...">
        </div>
        <div class="form-group">
          <label for="message">Order Notes (optional)</label>
          <textarea id="message" rows="2" placeholder="Any special instructions..."></textarea>
        </div>
      </div>
      
      <button type="submit" id="submitBtn">
        ⚡ Create Lightning Invoice
      </button>
      
      <div id="status" class="status"></div>
    </form>
    
    <footer>
      <p>Powered by <a href="https://bitcoinbutlers.com" target="_blank">Bitcoin Butlers</a> + Nostr</p>
    </footer>
  </div>
  
  <script type="module">
    // Configuration
    const MERCHANT_PUBKEY = '6750100bbcf478defd8a9c5e873b2e79d8fc12b30f7d54c9884f1d6c336b33e1';
    const RELAYS = ['wss://relay.damus.io', 'wss://nos.lol', 'wss://relay.primal.net'];
    
    // Products (can be fetched from API later)
    const PRODUCTS = [
      { id: 'coldcard-mk4', name: 'Coldcard MK4', price: 157.97, currency: 'USD' },
      { id: 'coldcard-q', name: 'Coldcard Q', price: 239.97, currency: 'USD' },
      { id: 'seedsigner', name: 'SeedSigner', price: 65.00, currency: 'USD' },
      { id: 'blockstream-jade', name: 'Blockstream Jade', price: 64.99, currency: 'USD' },
      { id: 'seed-plate', name: 'Seed Backup Plate (Steel)', price: 39.00, currency: 'USD' },
    ];
    
    // Render products
    const productsList = document.getElementById('productsList');
    PRODUCTS.forEach((p, i) => {
      const item = document.createElement('label');
      item.className = 'product-item' + (i === 0 ? ' selected' : '');
      item.innerHTML = `
        <input type="radio" name="product" value="${p.id}" ${i === 0 ? 'checked' : ''}>
        <div class="product-info">
          <div class="product-name">${p.name}</div>
        </div>
        <div class="product-price">$${p.price.toFixed(2)}</div>
      `;
      item.querySelector('input').addEventListener('change', () => {
        document.querySelectorAll('.product-item').forEach(el => el.classList.remove('selected'));
        item.classList.add('selected');
      });
      productsList.appendChild(item);
    });
    
    // Nostr utilities (minimal, no external deps)
    function bytesToHex(bytes) {
      return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
    }
    
    function hexToBytes(hex) {
      const bytes = new Uint8Array(hex.length / 2);
      for (let i = 0; i < hex.length; i += 2) {
        bytes[i / 2] = parseInt(hex.substr(i, 2), 16);
      }
      return bytes;
    }
    
    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      return bytesToHex(new Uint8Array(hashBuffer));
    }
    
    // Generate ephemeral keypair for this order
    async function generateKeypair() {
      const privateKey = bytesToHex(crypto.getRandomValues(new Uint8Array(32)));
      // For signing, we'll use the server-side bridge
      return { privateKey };
    }
    
    // Form submission
    const form = document.getElementById('orderForm');
    const status = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');
    
    function showStatus(message, type) {
      status.textContent = message;
      status.className = 'status show ' + type;
    }
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const selectedProduct = document.querySelector('input[name="product"]:checked');
      if (!selectedProduct) {
        showStatus('Please select a product', 'error');
        return;
      }
      
      const product = PRODUCTS.find(p => p.id === selectedProduct.value);
      const quantity = parseInt(document.getElementById('quantity').value) || 1;
      
      const order = {
        id: 'order-' + Date.now().toString(36),
        items: [{
          product_id: product.id,
          name: product.name,
          quantity: quantity,
          price: product.price,
          currency: product.currency
        }],
        shipping: {
          name: document.getElementById('name').value.trim(),
          street: document.getElementById('street').value.trim(),
          city: document.getElementById('city').value.trim(),
          region: document.getElementById('region').value.trim(),
          country: document.getElementById('country').value.trim(),
          zip: document.getElementById('zip').value.trim()
        },
        contact: document.getElementById('contact').value.trim(),
        message: document.getElementById('message').value.trim()
      };
      
      submitBtn.disabled = true;
      showStatus('Creating order via Nostr...', 'loading');
      
      try {
        // Send order to bridge API
        const response = await fetch('/api/order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            merchantPubkey: MERCHANT_PUBKEY,
            order: order
          })
        });
        
        const result = await response.json();
        
        if (result.success && result.invoice) {
          showStatus('Invoice created! Redirecting to payment...', 'success');
          status.innerHTML += `<a href="${result.invoice.checkoutLink}" class="invoice-link" target="_blank">⚡ Pay ${result.invoice.amount} ${result.invoice.currency}</a>`;
        } else if (result.success) {
          showStatus('Order submitted! You will receive payment instructions via your contact method.', 'success');
        } else {
          throw new Error(result.error || 'Failed to create order');
        }
      } catch (err) {
        showStatus('Error: ' + err.message, 'error');
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
